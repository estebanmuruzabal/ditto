{"ast":null,"code":"var __jsx = React.createElement;\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nimport React, { useState, useContext } from 'react';\nimport Link from 'next/link';\nimport { useMutation, useQuery } from '@apollo/react-hooks';\nimport { CommonMode, SensorsTypes, timezones } from 'utils/constant';\nimport ErrorMessage from 'components/error-message/error-message';\nimport { PlantsPageContainer, OrderDetails, BlockTitle, Text, ListItem, ListTitle, ListDes, ButtonText, PlantPageWrapper, Column1, Row1, DashboardContainer, SensorsWrapper } from './your-plants.style';\nimport { FormattedMessage, useIntl } from 'react-intl';\nimport { GET_LOGGED_IN_USER } from 'graphql/query/customer.query';\nimport { Button } from 'components/button/button';\nimport { CREATE_UPDATE_PLANT, DELETE_SETTING, UPDATE_SETTING } from 'graphql/query/plants.query';\nimport { Input } from 'components/forms/input';\nimport { ProfileContext } from 'contexts/profile/profile.context';\nimport { SuccessMsg } from 'features/user-profile/settings/settings.style';\nimport SoilHumiditySensor from './sensors/SoilHumiditySensor';\nimport LightSensor from './sensors/LightSensor';\nimport Select from 'react-select';\nimport Plug from './sensors/Plug';\nimport DistanceSensor from './sensors/DistanceSensor';\nimport { AuthContext } from 'contexts/auth/auth.context';\nimport { hasDittoBotUpdatedInLastMinute, getLastNumOfSensor, getSensorWithoutNumber } from 'utils/ditto-bot';\nimport moment from 'moment';\n\nconst YourPlants = ({\n  deviceType,\n  userRefetch\n}) => {\n  const {\n    state,\n    dispatch\n  } = useContext(ProfileContext);\n  const {\n    authDispatch\n  } = useContext(AuthContext);\n  const {\n    loading,\n    error,\n    data = {}\n  } = useQuery(GET_LOGGED_IN_USER, {\n    notifyOnNetworkStatusChange: true,\n    fetchPolicy: \"network-only\" // pollInterval: 5000,\n\n  }); // const { loading1, error1, data1 = {} } = useQuery(GET_LOGGED_IN_USER_SETTINGS, {\n  //   notifyOnNetworkStatusChange: true,\n  //   fetchPolicy: \"network-only\",\n  //   // pollInterval: 5000,\n  // });\n  // const router = useRouter();\n\n  const intl = useIntl();\n  const {\n    0: name,\n    1: setPlantName\n  } = useState('');\n  const {\n    0: openTab,\n    1: setOpenTab\n  } = useState('');\n  const {\n    0: errorId,\n    1: setErrorId\n  } = useState('');\n  const {\n    0: plantId,\n    1: setControllerID\n  } = useState('');\n  const {\n    0: userinfoMsg,\n    1: setUserinfoMsg\n  } = useState('');\n  const {\n    0: sensorSelected,\n    1: setSensor\n  } = useState('');\n  const {\n    0: timezoneSelected,\n    1: setTimezone\n  } = useState('');\n  const [addPlant] = useMutation(CREATE_UPDATE_PLANT);\n  const [updateSetting] = useMutation(UPDATE_SETTING);\n  const [deleteSetting] = useMutation(DELETE_SETTING);\n  const {\n    plants\n  } = state;\n\n  if (loading) {\n    return __jsx(ErrorMessage, {\n      message: 'Cargando...'\n    });\n  }\n\n  ;\n\n  if (error) {\n    return __jsx(ErrorMessage, {\n      message: error.message\n    });\n  }\n\n  ;\n\n  const shouldNotAssignRelay = (plant, field, value) => {\n    const relayOneIdRelated = 'relayOneIdRelated';\n    const relayTwoIdRelated = 'relayTwoIdRelated';\n    if (field !== relayOneIdRelated && field !== relayTwoIdRelated) return false;\n    plant.sensors.map(module => {\n      if ((module[relayOneIdRelated] === value || module[relayTwoIdRelated] === value) && value !== '') {\n        const texto1 = intl.formatMessage({\n          id: 'relayAlreadyAssinged',\n          defaultMessage: 'Relay already assigned in '\n        });\n        const texto2 = intl.formatMessage({\n          id: 'relayAlreadyAssinged2',\n          defaultMessage: 'desigagned  '\n        });\n        const hasConfirmed = confirm(texto1 + module.name + texto2);\n        if (hasConfirmed) return false;\n        return false;\n      }\n    });\n    return false;\n  };\n\n  const defaultSettingValuesIfModeChanges = (plant, field, value, settingType) => {\n    const mode = 'mode';\n    if (field !== mode) return plant;\n    const settingIndex = plant.sensors.findIndex(module => module.settingType === settingType);\n    plant.sensors[settingIndex] = getDefaultSetting(settingType, plant.sensors[settingIndex].name, value === CommonMode.NONE ? [] : plant.sensors[settingIndex].logs);\n    return plant;\n  };\n\n  const isClean = (plant, field, value) => {\n    // min max checks\n    const minWarning = 'minWarning';\n    const maxWarning = 'maxWarning';\n    if (field !== minWarning && field !== maxWarning) return true;\n\n    if (Number(value) < 0 || Number(value) > 100) {\n      setErrorId(field);\n      setTimeout(() => {\n        setErrorId('');\n      }, 2000);\n      return false;\n    }\n\n    setErrorId(''); // add more checks\n\n    return true;\n  };\n\n  const handleSettingsChange = (plant, field, value, settingType) => {\n    // if we want to stop user to reuse plugs, uncomment line bellow\n    if (shouldNotAssignRelay(plant, field, value)) return;\n    plant = defaultSettingValuesIfModeChanges(plant, field, value, settingType);\n    dispatch({\n      type: settingType,\n      payload: {\n        plant,\n        value,\n        field\n      }\n    });\n    if (isClean(plant, field, value)) dispatchSettingSave(plant, field, value, settingType);\n    setUserinfoMsg('Update user info successfully');\n    setTimeout(function () {\n      setUserinfoMsg('');\n    }, 8000);\n  };\n\n  const handleCreateUpdatePlantOnClick = (plant, name, newPlant, timeZone) => {\n    setTimezone(timeZone);\n    setTimeout(function () {\n      var _data$getUser;\n\n      addPlant({\n        variables: _objectSpread({\n          id: data === null || data === void 0 ? void 0 : (_data$getUser = data.getUser) === null || _data$getUser === void 0 ? void 0 : _data$getUser.id,\n          name,\n          plantId: newPlant ? Number(plantId) : plant.plantId\n        }, timeZone && {\n          timeZone\n        })\n      });\n    }, 2000);\n    setUserinfoMsg(newPlant ? 'added plant successfully' : 'updated plant successfully');\n    setTimeout(function () {\n      setUserinfoMsg('');\n    }, 2000);\n  };\n\n  const handleDeleteSensor = (plantSelected, settingType) => {\n    var _data$getUser2;\n\n    deleteSetting({\n      variables: {\n        id: data === null || data === void 0 ? void 0 : (_data$getUser2 = data.getUser) === null || _data$getUser2 === void 0 ? void 0 : _data$getUser2.id,\n        plantId: plantSelected.plantId,\n        settingName: settingType\n      }\n    });\n    const plantIndex = plants.findIndex(plant => plant.plantId === plantSelected.plantId);\n    const settingIndex = plants[plantIndex].sensors.findIndex(module => module.settingType === settingType);\n    dispatch({\n      type: 'DELETE_MODULE',\n      payload: {\n        plantIndex,\n        settingIndex\n      }\n    });\n    setUserinfoMsg('deleted setting successfully');\n    setTimeout(function () {\n      setUserinfoMsg('');\n    }, 2000);\n  };\n\n  const onDeleteSchedule = (plant, settingType, scheduleIndex) => {\n    var _plant$sensors$settin, _data$getUser3;\n\n    const settingIndex = plant.sensors.findIndex(module => module.settingType === settingType);\n    (_plant$sensors$settin = plant.sensors[settingIndex]) === null || _plant$sensors$settin === void 0 ? void 0 : _plant$sensors$settin.scheduledOnTimes.splice(scheduleIndex, 1);\n    updateSetting({\n      variables: {\n        id: data === null || data === void 0 ? void 0 : (_data$getUser3 = data.getUser) === null || _data$getUser3 === void 0 ? void 0 : _data$getUser3.id,\n        plantId: plant.plantId,\n        input: _objectSpread(_objectSpread({}, plant.sensors[settingIndex]), {}, {\n          settingType: settingType\n        })\n      }\n    });\n    setUserinfoMsg('deleted schedule successfully');\n    setTimeout(function () {\n      setUserinfoMsg('');\n    }, 2000);\n  };\n\n  const getDefaultSetting = (settingTypeName, name, logs) => {\n    return {\n      name: name || '',\n      whatsappWarningsOn: false,\n      maxWarning: '',\n      minWarning: '',\n      mode: CommonMode.NONE,\n      relayOneAutomatedTimeToRun: '',\n      relayTwoAutomatedStartedTime: '',\n      relayOneAutomatedStartedTime: '',\n      relayOneIdRelated: '',\n      relayOneWorking: false,\n      relayTwoAutomatedTimeToRun: '',\n      relayTwoIdRelated: '',\n      relayTwoWorking: false,\n      logs: logs || [],\n      scheduledOnTimes: [],\n      settingType: settingTypeName\n    };\n  };\n\n  const dispatchSettingSave = (plant, fieldName, fieldValue, settingType) => {\n    var _data$getUser4;\n\n    const settingIndex = plant.sensors.findIndex(module => module.settingType === settingType);\n    plant.sensors[settingIndex][fieldName] = fieldValue;\n    updateSetting({\n      variables: {\n        id: data === null || data === void 0 ? void 0 : (_data$getUser4 = data.getUser) === null || _data$getUser4 === void 0 ? void 0 : _data$getUser4.id,\n        plantId: plant.plantId,\n        input: plant.sensors[settingIndex]\n      }\n    });\n  };\n\n  const getSensorCompleteName = (plant, settingType) => {\n    var _plant$sensors;\n\n    let sensorNewNumber = 1;\n    plant === null || plant === void 0 ? void 0 : (_plant$sensors = plant.sensors) === null || _plant$sensors === void 0 ? void 0 : _plant$sensors.map(module => {\n      let lastSensorNum = getLastNumOfSensor(module.settingType);\n      const rawSensorTypeName = getSensorWithoutNumber(module === null || module === void 0 ? void 0 : module.settingType);\n\n      if (!isNaN(lastSensorNum) && rawSensorTypeName === settingType) {\n        sensorNewNumber = lastSensorNum + 1;\n      }\n    });\n    return `${settingType}_${sensorNewNumber}`;\n  };\n\n  const dispatchNewSettingSave = (plant, settingType, plantIndex) => {\n    var _data$getUser5;\n\n    const completeSensorTypeName = getSensorCompleteName(plant, settingType);\n    updateSetting({\n      variables: {\n        id: data === null || data === void 0 ? void 0 : (_data$getUser5 = data.getUser) === null || _data$getUser5 === void 0 ? void 0 : _data$getUser5.id,\n        plantId: plant.plantId,\n        input: getDefaultSetting(completeSensorTypeName)\n      }\n    });\n    dispatch({\n      type: 'ADD_MODULE',\n      payload: {\n        plantIndex,\n        setting: getDefaultSetting(completeSensorTypeName)\n      }\n    });\n  };\n\n  const selectStyle = {\n    control: styles => _objectSpread(_objectSpread({}, styles), {}, {\n      width: '197px',\n      textAlign: 'left'\n    })\n  };\n  const sensorsOptions = [{\n    value: SensorsTypes.DISTANCE,\n    label: intl.formatMessage({\n      id: 'distanceId',\n      defaultMessage: 'distanceId'\n    })\n  }, {\n    value: SensorsTypes.SOIL_HUMIDITY,\n    label: intl.formatMessage({\n      id: 'moistHumidityId',\n      defaultMessage: 'moistHumidityId'\n    })\n  }, {\n    value: SensorsTypes.HUMIDITY_TEMPETURE,\n    label: intl.formatMessage({\n      id: 'airHumidityAndTempetureId',\n      defaultMessage: 'airHumidityAndTempetureId'\n    })\n  }, {\n    value: SensorsTypes.LIGHT,\n    label: intl.formatMessage({\n      id: 'lightSensorId',\n      defaultMessage: 'lightSensorId'\n    })\n  }, {\n    value: SensorsTypes.PLUG,\n    label: intl.formatMessage({\n      id: 'intelligentPlugId',\n      defaultMessage: 'intelligentPlugId'\n    })\n  }];\n  const timezonesList = timezones.map(timezone => ({\n    value: timezone,\n    label: timezone\n  }));\n  console.log('plants', plants);\n  return __jsx(PlantPageWrapper, null, __jsx(PlantsPageContainer, {\n    style: {\n      width: '100%'\n    }\n  }, __jsx(Link, {\n    href: \"/profile\"\n  }, __jsx(\"a\", {\n    className: \"home-btn\"\n  }, __jsx(FormattedMessage, {\n    id: \"backProfileBtn\",\n    defaultMessage: \"Back to Profile\"\n  }))), __jsx(OrderDetails, null, __jsx(BlockTitle, null, __jsx(FormattedMessage, {\n    id: \"dittoBotsIds\",\n    defaultMessage: \"dittoBotsIds\"\n  })), (plants === null || plants === void 0 ? void 0 : plants.length) < 1 && __jsx(Text, null, intl.formatMessage({\n    id: 'noDittoBotsTextId',\n    defaultMessage: 'noDittoBotsTextId'\n  })), plants === null || plants === void 0 ? void 0 : plants.map((plant, i) => {\n    var _plant$timestamp;\n\n    const {\n      sensors\n    } = plant;\n    return __jsx(DashboardContainer, {\n      key: i + '-orderList'\n    }, __jsx(Row1, null, __jsx(Column1, null, __jsx(ListItem, null, __jsx(ListTitle, null, __jsx(Text, {\n      bold: true\n    }, __jsx(FormattedMessage, {\n      id: \"controllerNameId\",\n      defaultMessage: \"controllerNameId\"\n    }))), __jsx(ListDes, null, __jsx(Input, {\n      type: \"text\",\n      name: \"name\",\n      disabled: true,\n      value: plant === null || plant === void 0 ? void 0 : plant.name // we have to change the onChange because the is no one for the controller name actualy\n      ,\n      onChange: e => handleCreateUpdatePlantOnClick(plant, e.target.value, false),\n      backgroundColor: \"#F7F7F7\",\n      width: \"197px\",\n      height: \"34.5px\"\n    }))), __jsx(ListItem, null, __jsx(ListTitle, null, __jsx(Text, {\n      bold: true\n    }, __jsx(FormattedMessage, {\n      id: \"statusId\",\n      defaultMessage: \"statusId\"\n    }))), __jsx(ListDes, null, __jsx(Text, null, ((_plant$timestamp = plant.timestamp) === null || _plant$timestamp === void 0 ? void 0 : _plant$timestamp.length) > 0 ? moment(plant.timestamp).format('hh:mm A - DD MMM') : '', \" \", hasDittoBotUpdatedInLastMinute(plant.timestamp, plant.timeZone) ? '[ONLINE]' : '[OFFLINE]'))), __jsx(ListItem, {\n      style: {\n        justifyContent: 'flex-start'\n      }\n    }, __jsx(ListTitle, null, __jsx(Text, {\n      bold: true\n    }, __jsx(FormattedMessage, {\n      id: \"addSensorId\",\n      defaultMessage: \"addSensorId\"\n    }))), __jsx(ListDes, null, __jsx(Select, {\n      onChange: e => dispatchNewSettingSave(plant, e.value, i),\n      value: sensorSelected // @ts-ignore\n      ,\n      options: sensorsOptions,\n      styles: selectStyle,\n      menuPosition: 'fixed'\n    }))), __jsx(ListItem, {\n      style: {\n        justifyContent: 'flex-start'\n      }\n    }, __jsx(ListTitle, null, __jsx(Text, {\n      bold: true\n    }, __jsx(FormattedMessage, {\n      id: \"timezone\",\n      defaultMessage: \"timezone\"\n    }))), __jsx(ListDes, null, __jsx(Select, {\n      onChange: e => handleCreateUpdatePlantOnClick(plant, plant.name, false, e.value),\n      value: timezoneSelected // @ts-ignore\n      ,\n      options: timezonesList,\n      styles: selectStyle,\n      menuPosition: 'fixed'\n    }))))), __jsx(SensorsWrapper, null, sensors === null || sensors === void 0 ? void 0 : sensors.map((module, index) => {\n      switch (module === null || module === void 0 ? void 0 : module.settingType) {\n        case `${SensorsTypes.SOIL_HUMIDITY}_1`:\n        case `${SensorsTypes.SOIL_HUMIDITY}_2`:\n        case `${SensorsTypes.SOIL_HUMIDITY}_3`:\n          // check the number of same setting to send\n          return __jsx(SoilHumiditySensor, {\n            key: i + module.settingType,\n            data: data,\n            plant: plant,\n            errorId: errorId,\n            openTab: openTab,\n            handleDeleteSensor: handleDeleteSensor,\n            setOpenTab: setOpenTab,\n            settingType: module.settingType,\n            handleSettingsChange: handleSettingsChange,\n            onDeleteSchedule: onDeleteSchedule\n          });\n\n        case `${SensorsTypes.LIGHT}_1`:\n          return __jsx(LightSensor, {\n            key: i + module.settingType,\n            data: data,\n            errorId: errorId,\n            plant: plant,\n            handleDeleteSensor: handleDeleteSensor,\n            openTab: openTab,\n            setOpenTab: setOpenTab,\n            settingType: module.settingType,\n            handleSettingsChange: handleSettingsChange,\n            onDeleteSchedule: onDeleteSchedule\n          });\n\n        case `${SensorsTypes.DISTANCE}_1`:\n          return __jsx(DistanceSensor, {\n            key: i + module.settingType,\n            data: data,\n            plant: plant,\n            errorId: errorId,\n            handleDeleteSensor: handleDeleteSensor,\n            openTab: openTab,\n            setOpenTab: setOpenTab,\n            settingType: module.settingType,\n            handleSettingsChange: handleSettingsChange,\n            onDeleteSchedule: onDeleteSchedule\n          });\n\n        case `${SensorsTypes.PLUG}_1`:\n          return __jsx(Plug, {\n            key: i + module.settingType,\n            data: data,\n            plant: plant,\n            handleDeleteSensor: handleDeleteSensor,\n            openTab: openTab,\n            setOpenTab: setOpenTab,\n            settingType: module.settingType,\n            handleSettingsChange: handleSettingsChange,\n            onDeleteSchedule: onDeleteSchedule\n          });\n\n        default:\n          break;\n      }\n    })));\n  }), userinfoMsg && __jsx(SuccessMsg, null, __jsx(FormattedMessage, {\n    id: \"userInfoSuccess\",\n    defaultMessage: userinfoMsg\n  })))), __jsx(PlantsPageContainer, {\n    style: {\n      width: '100%'\n    }\n  }, __jsx(BlockTitle, null, __jsx(FormattedMessage, {\n    id: \"addController\",\n    defaultMessage: \"Your Plants\"\n  })), __jsx(ListItem, null, __jsx(ListTitle, null, __jsx(Text, {\n    bold: true\n  }, __jsx(FormattedMessage, {\n    id: \"plantNameField\",\n    defaultMessage: \"Name of the plant\"\n  }))), __jsx(ListDes, null, __jsx(Input, {\n    type: \"text\",\n    name: \"name\",\n    value: name,\n    onChange: e => setPlantName(e.target.value),\n    placeholder: intl.formatMessage({\n      id: 'plantNamePlaceholderId',\n      defaultMessage: 'Balcony plants'\n    }),\n    backgroundColor: \"#F7F7F7\",\n    width: \"197px\"\n  }))), __jsx(ListItem, null, __jsx(ListTitle, null, __jsx(Text, {\n    bold: true\n  }, __jsx(FormattedMessage, {\n    id: \"plantIdField\",\n    defaultMessage: \"ID of the controller\"\n  }))), __jsx(ListDes, null, __jsx(Input, {\n    type: \"number\",\n    name: \"plantId\",\n    value: plantId,\n    onChange: e => setControllerID(e.target.value),\n    placeholder: intl.formatMessage({\n      id: 'serialNumberPlaceholderId',\n      defaultMessage: 'Look behind Ditto Bot'\n    }),\n    backgroundColor: \"#F7F7F7\",\n    width: \"197px\"\n  }))), __jsx(Button, {\n    className: \"cart-button\",\n    variant: \"secondary\",\n    borderRadius: 100,\n    onClick: () => handleCreateUpdatePlantOnClick(plants, name, true)\n  }, __jsx(ButtonText, null, __jsx(FormattedMessage, {\n    id: \"addDittoBotButton\",\n    defaultMessage: \"Add plant\"\n  })))));\n};\n\nexport default YourPlants;","map":null,"metadata":{},"sourceType":"module"}